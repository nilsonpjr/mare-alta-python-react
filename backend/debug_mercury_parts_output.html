<script language="JavaScript">
 window.open('epdv000s.asp', '_top' , '');
</script>
<noscript>
 <meta content="0; url=epdv000j.html" http-equiv="refresh"/>
</noscript>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
  <title>
   epdv002d2
  </title>
  <meta content="CodeCharge Studio 4.3.00.7676" name="GENERATOR"/>
 </head>
 <body>
  <noscript>
  </noscript>
  <script language="JavaScript" type="text/javascript">
   //Begin CCS script
        //Include Common JSFunctions @1-D6831454
  </script>
  <script charset="utf-8" language="JavaScript" src="ClientI18N.asp?file=Functions.js&amp;locale=pt-BR" type="text/javascript">
  </script>
  <script language="JavaScript" type="text/javascript">
   //End Include Common JSFunctions

        //preco_item_webCancel_OnClick @44-2FFBAD32
        function preco_item_webCancel_OnClick() {
            var result = true;
            //End preco_item_webCancel_OnClick

            //Custom Code @45-2A29BDB7
            // -------------------------
            window.open("epdv002c.asp?s_nr_pedido_web=" + document.preco_item_web.h_nr_pedido_web.value, "mainFrameAux", "width=400,height=300,scrollbars=yes");
            // -------------------------
            //End Custom Code

            //Close preco_item_webCancel_OnClick @44-AEF500E0
            disableValidation = true;
            return result;
        }
        //End Close preco_item_webCancel_OnClick

        //preco_item_webquant_ped_OnChange @209-D2AB887B
        function preco_item_webquant_ped_OnChange() {
            var result = true;
            //End preco_item_webquant_ped_OnChange

            //Custom Code @210-2A29BDB7
            // -------------------------
            var url = location.href;
            var tam = 0;
            var qtd = 0;
            var ped = 0;
            var mult = 0;
            var min = 0;
            var preco = 0;
            var subtotal = 0;
            var total = 0;
            var str = this.id;
            var i = str.search("_ped_");
            var rest = 0;
            var sit = 0;
            var sld = 0;

            i = str.substring(i + 5);

            sit = parseInt(eval("document.preco_item_web.h_situacao_" + i + ".value"));
            sld = parseInt(eval("document.preco_item_web.h_quant_saldo_" + i + ".value"));

            if ((sit == 2) && (sld <= 0)) {
                alert("Este ítem está obsoleto e não pode ser solicitado!");
                eval("document.preco_item_web.quant_ped_" + i + ".value=" + 0);
            }

            ped = parseInt(eval("document.preco_item_web.quant_ped_" + i + ".value"));
            mult = parseInt(eval("document.preco_item_web.h_lote_multipl_" + i + ".value"));
            min = parseInt(eval("document.preco_item_web.h_quant_min_" + i + ".value"));
            rest = parseInt(eval(ped % mult));

            if ((ped > 0) && (rest > 0)) {
                alert("Este ítem possui lote multiplo de " + mult + ".\nA quantidade será ajustada!");
                if (ped < mult) {
                    eval("document.preco_item_web.quant_ped_" + i + ".value=" + (mult));
                } else {
                    ped = (ped - rest) + mult;
                    eval("document.preco_item_web.quant_ped_" + i + ".value=" + (ped));
                }
            }

            qtd = eval("document.preco_item_web.quant_ped_" + i + ".value");
            qtd = qtd.replace(',', '.');

            if (qtd > 0) {
                if (qtd < min) {
                    alert("Quantidade solicitada para esse ítem não pode ser inferior a " + min);
                    eval("document.preco_item_web.quant_ped_" + i + ".value=" + 0);
                } else {
                    preco = eval("document.preco_item_web.h_preco_final_" + i + ".value");
                    preco = preco.replace(',', '.');
                    subtotal = (qtd * preco);
                    eval("document.preco_item_web.preco_total_" + i + ".value=" + subtotal.toFixed(2));
                }
            }
            // -------------------------
            //End Custom Code

            //Close preco_item_webquant_ped_OnChange @209-BC33A33A
            return result;
        }
        //End Close preco_item_webquant_ped_OnChange

        async function InsereItem() {
            var result = true;
            var url = location.href;
            var tam = 0;
            var qtd = 0;
            var preco = 0;
            var total = 0;
            var i = 0;
            var sMsg;
            var sGet1 = "";
            var sGet2 = "";
            let quantidadeItensOleo = 0;

            tam = parseInt(((document.preco_item_web.length - 8) / 11));
            document.preco_item_web.h_vet.value = tam;

            for (i = 1; i <= tam; i++) {
                qtd = eval("document.preco_item_web.quant_ped_" + i + ".value");
                qtd = qtd.replace(',', '.');

                if (qtd > 0) {
                    if (eval("document.preco_item_web.h_nr_tabpre_" + i + ".value") === "OLEO") {
                        const ehSedex = await verificaItemOleoSeTransportadoraEhSedex();
                        if (ehSedex) {
                            alert('Prezado Usuário, este item não poderá ser adicionado ao pedido.\nMotivo: Item não pode ser enviado por SEDEX');
                            return false; // <-- agora sai de InsereItem
                        }
                    }

                    preco = eval("document.preco_item_web.h_preco_final_" + i + ".value");
                    preco = preco.replace(',', '.');
                    total = total + (qtd * preco);
                    sGet2 = sGet2 + "&h_it_codigo_" + i + "=" + eval("document.preco_item_web.h_it_codigo_" + i + ".value");
                    sGet2 = sGet2 + "&h_nr_tabpre_" + i + "=" + eval("document.preco_item_web.h_nr_tabpre_" + i + ".value");
                    sGet2 = sGet2 + "&quant_ped_" + i + "=" + eval("document.preco_item_web.quant_ped_" + i + ".value");
                    sGet2 = sGet2 + "&h_quant_saldo_" + i + "=" + eval("document.preco_item_web.h_quant_saldo_" + i + ".value");
                    sGet2 = sGet2 + "&h_preco_venda_" + i + "=" + eval("document.preco_item_web.h_preco_venda_" + i + ".value");
                    sGet2 = sGet2 + "&h_preco_final_" + i + "=" + eval("document.preco_item_web.h_preco_final_" + i + ".value");
                }
            }

            if (total == 0) {
                sMsg = "****** ATENÇÃO ******\n\n Nenhum item foi informado! ";
                alert(sMsg);
            } else {
                sGet1 = "epdv002da.asp?s_nr_pedido_web=" + document.preco_item_web.h_nr_pedido_web.value;
                sGet1 = sGet1 + "&h_vet=" + document.preco_item_web.h_vet.value;
                sGet1 = sGet1 + "&s_nome=" + document.preco_item_web.h_nome.value;
                sGet1 = sGet1 + sGet2;

                window.open(sGet1, "mainFrameAux", "");
            }

            return result;
        }

        async function verificaItemOleoSeTransportadoraEhSedex() {
            const params = new URLSearchParams(window.location.search);
            const numeroPedido = params.get("s_nr_pedido_web");
            let transportadoraPedidoSedex = false;

            await fetch('services/epdv002d2VerificaTransportadoraSEDEX.asp?nrPedidoWeb=' + numeroPedido, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json; charset=utf-8"
                }
            })
                .then(response => response.text())
                .then(responsetransportadoraPedidoSedex => {
                    transportadoraPedidoSedex = responsetransportadoraPedidoSedex === "1" ? true : false;
                })
                .catch(error => {
                    console.error("Erro na requisição: ", error);
                    alert('Houve uma falha ao verificar os dados do D365, de modo que apenas o status de garantia será atualizado.\nPor favor, informe ao setor de T.I.');

                })

            return transportadoraPedidoSedex;
        }

        //preco_item_webCancel1_OnClick @221-CF9E3229
        function preco_item_webCancel1_OnClick() {
            var result = true;
            //End preco_item_webCancel1_OnClick

            //Custom Code @222-2A29BDB7
            // -------------------------
            window.open("epdv002c.asp?s_nr_pedido_web=" + document.preco_item_web.h_nr_pedido_web.value, "mainFrameAux", "width=400,height=300,scrollbars=yes");
            // -------------------------
            //End Custom Code

            //Close preco_item_webCancel1_OnClick @221-AEF500E0
            disableValidation = true;
            return result;
        }
        //End Close preco_item_webCancel1_OnClick


        //preco_item_web_OnLoad @2-C037E9D2
        function preco_item_web_OnLoad() {
            var result = true;
            //End preco_item_web_OnLoad

            //Custom Code @95-2A29BDB7
            // -------------------------
            //if(document.preco_item_webSearch.s_fm_cod_com.value != ""){document.preco_item_web.quant_min_1.value="";document.preco_item_web.quant_min_1.focus();}
            // -------------------------
            //End Custom Code

            //Close preco_item_web_OnLoad @2-BC33A33A
            return result;
        }
        //End Close preco_item_web_OnLoad

        //Função funcaoAspx (ConsultPartNumber.aspx)

        function funcaoAspx(sLink, sNM, sNA) {
            frmMenuAspx.action = "ConsultPartNumber.aspx";
            frmMenuAspx.target = "EPDV"
            frmMenuAspx.p1.value = sLink;
            frmMenuAspx.pNM.value = sNM;
            frmMenuAspx.pNA.value = sNA;
            frmMenuAspx.sesCdUsr.value = '<%=Session("sesCdUsr")%>'
            frmMenuAspx.submit();
        }

        //bind_events @1-B5A71BC1
        function bind_events() {
            addEventHandler("preco_item_webCancel", "click", preco_item_webCancel_OnClick);
            addEventHandler("preco_item_webButton_Insert", "click", InsereItem);
            addEventHandler("preco_item_webquant_ped", "change", preco_item_webquant_ped_OnChange);
            addEventHandler("preco_item_webButton_Insert1", "click", InsereItem);
            addEventHandler("preco_item_webCancel1", "click", preco_item_webCancel1_OnClick);
            addEventHandler("preco_item_web", "load", preco_item_web_OnLoad);
        }
        //End bind_events

        window.onload = bind_events; //Assign bind_events @1-19F7B649

        //End CCS script
  </script>
  <link href="Styles/ePDV_Merc/Style_doctype.css" rel="stylesheet" type="text/css"/>
  <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
  <form action="epdv002d2.asp?s_nr_pedido_web=11111111111111111&amp;s_nr_tabpre=&amp;s_fm_cod_com=null&amp;s_desc_item=filtro&amp;ccsForm=preco_item_web" id="preco_item_web" method="post" name="preco_item_web">
   <input name="FormState" type="hidden" value="0;0"/>
   <script language="JavaScript" type="text/javascript">
    <!--
var preco_item_webElements;
var preco_item_webEmptyRows = 0;
var preco_item_webh_quant_minID = 0;
var preco_item_webh_it_codigoID = 1;
var preco_item_webpreco_totalID = 2;
var preco_item_webh_nr_tabpreID = 3;
var preco_item_webh_vetID = 4;
var preco_item_webh_nr_pedido_webID = 5;
var preco_item_webquant_pedID = 6;
var preco_item_webh_preco_finalID = 7;
var preco_item_webh_preco_vendaID = 8;
var preco_item_webh_nomeID = 9;
var preco_item_webh_lote_multiplID = 10;
var preco_item_webh_cor_saldoID = 11;
var preco_item_webh_quant_saldoID = 12;
var preco_item_webh_situacaoID = 13;

function initpreco_item_webElements() {
	var ED = document.forms["preco_item_web"];
	preco_item_webElements = new Array (
);
}

//-->
   </script>
   <table border="0" cellpadding="0" cellspacing="0">
    <tr>
     <td valign="top">
      <table border="0" cellpadding="0" cellspacing="0" class="Header">
       <tr>
        <td class="HeaderLeft">
         <img alt="" border="0" src="Styles/ePDV_Merc/Images/Spacer.gif"/>
        </td>
        <td class="th">
         <strong>
          Itens
         </strong>
        </td>
        <td class="HeaderRight">
         <img alt="" border="0" src="Styles/ePDV_Merc/Images/Spacer.gif"/>
        </td>
       </tr>
      </table>
      <table cellpadding="0" cellspacing="0" class="Grid">
       <tr class="Error">
        <td colspan="9">
         Incorrect syntax near the keyword 'AND'. (Microsoft OLE DB Driver for SQL Server)
        </td>
       </tr>
       <tr class="Row">
        <td colspan="5" style="TEXT-ALIGN: left">
         <input alt="Fechar" class="Button" id="preco_item_webCancel" name="Cancel" type="button" value="Fechar"/>
         <input alt="Confirmar" class="ButtonAdd" id="preco_item_webButton_Insert" name="Button_Insert" type="button" value="Salvar"/>
        </td>
        <td colspan="4" style="TEXT-ALIGN: right">
         Total de Registros:  0
        </td>
       </tr>
       <tr class="Caption">
        <th scope="col">
         <a href="epdv002d2.asp?s_nr_pedido_web=11111111111111111&amp;s_nr_tabpre=&amp;s_fm_cod_com=null&amp;s_desc_item=filtro&amp;preco_item_webOrder=Sorter_quant_min&amp;preco_item_webDir=ASC" id="preco_item_webSorter_quant_min">
          Quant
         </a>
        </th>
        <th scope="col">
         <a href="epdv002d2.asp?s_nr_pedido_web=11111111111111111&amp;s_nr_tabpre=&amp;s_fm_cod_com=null&amp;s_desc_item=filtro&amp;preco_item_webOrder=Sorter_it_codigo&amp;preco_item_webDir=ASC" id="preco_item_webSorter_it_codigo">
          Item
         </a>
        </th>
        <th scope="col">
         Unid
         <br/>
         p/ Lote
        </th>
        <th scope="col">
         <a href="epdv002d2.asp?s_nr_pedido_web=11111111111111111&amp;s_nr_tabpre=&amp;s_fm_cod_com=null&amp;s_desc_item=filtro&amp;preco_item_webOrder=Sorter_desc_item&amp;preco_item_webDir=ASC" id="preco_item_webSorter_desc_item">
          Nome
         </a>
        </th>
        <th scope="col">
         Saldo
        </th>
        <th scope="col">
         <a href="epdv002d2.asp?s_nr_pedido_web=11111111111111111&amp;s_nr_tabpre=&amp;s_fm_cod_com=null&amp;s_desc_item=filtro&amp;preco_item_webOrder=Sorter_preco_suger&amp;preco_item_webDir=ASC" id="preco_item_webSorter_preco_suger">
          Preço
          <br/>
          Tabela
         </a>
        </th>
        <th scope="col">
         <a href="epdv002d2.asp?s_nr_pedido_web=11111111111111111&amp;s_nr_tabpre=&amp;s_fm_cod_com=null&amp;s_desc_item=filtro&amp;preco_item_webOrder=Sorter_preco_venda&amp;preco_item_webDir=ASC" id="preco_item_webSorter_preco_venda">
          Preço
          <br/>
          Base
         </a>
        </th>
        <th scope="col">
         <a href="epdv002d2.asp?s_nr_pedido_web=11111111111111111&amp;s_nr_tabpre=&amp;s_fm_cod_com=null&amp;s_desc_item=filtro&amp;preco_item_webOrder=Sorter_preco_final&amp;preco_item_webDir=ASC" id="preco_item_webSorter_preco_final">
          Preço
          <br/>
          Compra
         </a>
        </th>
        <th scope="col">
         <a href="epdv002d2.asp?s_nr_pedido_web=11111111111111111&amp;s_nr_tabpre=&amp;s_fm_cod_com=null&amp;s_desc_item=filtro&amp;preco_item_webOrder=Sorter_preco_fob&amp;preco_item_webDir=ASC" id="preco_item_webSorter_preco_fob">
          Total do
                                    Item
         </a>
        </th>
       </tr>
       <tr class="NoRecords">
        <td colspan="9">
         Nenhum registro encontrado
         <br/>
         Favor verificar informação do item
                                clicando aqui:
         <input class="ButtonNew" name="Button1" onclick="funcaoAspx('ConsultPartNumber.aspx','1','1','mainFrame')" style="width: 101px" type="button" value="Consulta Preço"/>
        </td>
       </tr>
       <tr class="Footer">
        <td colspan="9" style="TEXT-ALIGN: left">
         <input alt="Fechar" class="Button" id="preco_item_webCancel1" name="Cancel1" type="button" value="Fechar"/>
         <input alt="Confirmar" class="ButtonAdd" id="preco_item_webButton_Insert1" name="Button_Insert1" type="button" value="Salvar"/>
         <input id="preco_item_webh_vet" name="h_vet" type="hidden" value=""/>
         <input id="preco_item_webh_nr_pedido_web_" name="h_nr_pedido_web" type="hidden" value=""/>
         <input id="preco_item_webh_nome_" name="h_nome" type="hidden" value=""/>
        </td>
       </tr>
      </table>
     </td>
    </tr>
   </table>
  </form>
  <form method="post" name="frmMenuAspx">
   <input name="p1" type="hidden"/>
   <input name="p2" type="hidden"/>
   <input name="pNM" type="hidden"/>
   <input name="pNA" type="hidden"/>
   <input name="sTarget" type="hidden"/>
   <input name="sesCdUsr" type="hidden"/>
  </form>
  <br/>
 </body>
</html>